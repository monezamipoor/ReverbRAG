seed: 42

run:
  model: avnerf                # {neraf | avnerf}
  database: raf               # {raf | soundspaces}
  scene: FurnishedRoom        # e.g., EmptyRoom, FurnishedRoom
  sample_rate: 48000
  epochs: 100
  lr: 1.0e-3
  temporal_attention_lr_mult: 0.1   # multiplier for temporal stack LR (used only if temporal_attention.enabled=true)
  grad_clip:
    enabled: false
    max_norm: 1.0
    norm_type: 2.0
  save_root: ./checkpoints          # root for run folders
  save_every: 10              # save every N epochs
  resume:
    checkpoint: null        # e.g., ./runs/raf/FurnishedRoom/20251106-2130_base/epoch_50.pt
    load_optimizer: false     # if true, restore optimizer state (and LR scheduler progress)
    lr_override: null         # e.g., 1e-4; if set, forces this LR after resume

  losses:
    sc: 0.0              # weight for spectral convergence loss
    mag: 0.0             # weight for log-magnitude loss
    mag_loss_type: mse   # {l1 | mse} for the log-mag term
    mse: 1.0             # set >0 to add F.mse_loss(log_pred, log_gt)
    # EDC loss (forces full-STFT sampler when > 0)
    edc: 0.2             # 0.0 disables EDC
    # Optional multi-band EDC mode (applies ONLY if edc > 0).
    # Uses the same base EDC weight above.
    edc_band:
      enabled: false
      type: "third_octave"          # {"8" | "16" | "octave" | "third_octave"}
    # Envelope / residual regularization
    env_rms: 0.0         # weight for global RMS envelope loss (log-domain, uses full STFT)
    res_l2: 0.0          # L2 regularization on residual log-STFT
    # Global scale for the total loss (applied at the end)
    global_scale: 1.0e-3
    # Optional early-time weighting for frame-local STFT losses.
    time_weight:
      enabled: false
      early_frames: 12      # first N frames to boost (12 * 5ms ~= 60ms)
      early_gain: 2.0       # multiplier on early frames
      normalize_mean: true  # keep mean weight ~1
      max_frames: 60
      apply_to_mag: true
      apply_to_mse: true
    # Optional multi-resolution STFT loss computed on waveforms reconstructed with GT phase.
    mrstft:
      enabled: false
      weight: 0.3
      loss_type: l1          # {l1|mse} over log-magnitude STFTs
      freq_focus: none       # {none|low}
      low_hz: 300.0
      scales:
        - { n_fft: 512,  win_length: 256,  hop_length: 128,  w: 1.0 }  # shorter window (time detail)
        - { n_fft: 1024, win_length: 512,  hop_length: 256,  w: 1.0 }  # baseline scale
        - { n_fft: 2048, win_length: 1024, hop_length: 512,  w: 1.5 }  # longer window (freq detail)
    optimizer: avnerf    # {neraf | avnerf} selects which pred to use for loss

renders:
  save_renders: ./renders   # set to null to disable
  model: ./checkpoints/20251110-2341_base/epoch_60.pt  # path to trained model; set to null to use latest checkpoint from run

  # logging
  log_every: 50               # iterations

sampler:
  batch_size: 2048         # Normal batch size (Not EDC mode)
  rirs_per_batch: 40       # only for EDC mode
  shuffle: true
  num_workers: 8

wandb:
  project: ReverbRAG
  api_key: null    # optional; leave null if you've already `wandb login`

databases:
  raf:
    root: ../NeRAF/data/RAF
  soundspaces:
    root: /data/SoundSpaces

model:

  temporal_attention:
    enabled: false        # when true, force sequence-style training batches
    causal: true          # each frame attends only to <= current frame
    n_layers: 2
    n_heads: 8
    dropout: 0.1

  envelope:
    enabled: false                # flip this off for ablations
    hidden: [2048, 1024, 1024, 512]  # 4-layer MLP  1024,512,256,256    2048, 1024, 1024, 512
    act: lrelu                    # {relu | lrelu | gelu | silu}
    tanh_scale: 0.0               # scale for tanh-bounded log envelope
    n_frames: 60                  # expected T; matches EDC bins
    normalize: true               # normalize residual STFT mags
    combine_mode: "log"           # or "log" how to combine envelope + detail

  reverbrag:
    enabled: false
    fusion: film         # {film | concat | input}
    k: 1                      # we only use top-1 here
    num_bands: 32             # features are [32 x 4]
    gating: true              # enable scalar gate

    # reference MLP over 32x4 features
    mlp_hidden: [128, 256, 256]
    mlp_act: lrelu             # {gelu | relu | lrelu | silu}
    feature_norm: "layernorm"

    # FiLM parameters
    film_strength: 0.15        # near-identity at init
    learnable_film: true      # make scales learnable (recommended)

  neraf_encoder:
    hidden: [5096, 2048, 1024, 1024]
  avnerf_encoder:
    hidden: [5096, 2048, 1024, 1024]
  decoder:
    # empty list = single Linear(W, N_freq) per channel (old behaviour)
    # e.g. [2048, 1024] would give W -> 2048 -> 1024 -> N_freq
    hidden: []
    # Optional low-frequency global decoder branch:
    # predicts first lf_bins (or bins up to lf_max_hz) for all frames jointly.
    lf_global:
      enabled: false
      # Pick one: set lf_bins directly, or leave null and use lf_max_hz.
      lf_bins: null
      lf_max_hz: 300.0
      seq_len: 60
      hidden: []   # empty -> single Linear over flattened [T x (W+dir)]
